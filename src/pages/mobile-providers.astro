---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getMobileProviders } from '../lib/supabase';
import { mobileProviders as staticProviders } from '../data/mobileProviders';
import { Phone, Search, Globe, AlertCircle } from 'lucide-react';

// Fetch providers from Supabase
const providersData = await getMobileProviders();

// Map Supabase data to match old format
const mobileProviders = providersData.map(provider => {
  const staticProvider = staticProviders.find(p => p.id === provider.id || p.name === provider.name);
  return {
    id: provider.id,
    name: provider.name,
    colour: staticProvider?.colour || '#1d4ed8', // Use static color if available
    initial: provider.name.charAt(0).toUpperCase(),
    emergencyContact: {
      uk: provider.phone || 'Online only - web chat',
      available: provider.phone ? 'Available 24/7' : 'Support via online account only',
    },
    network: provider.network,
    website: provider.website,
    is_mvno: provider.is_mvno,
    // Default steps
    steps: [
      provider.phone ? 'Call customer services to report your SIM stolen' : 'Log into your account on another device',
      'Request to block your SIM card immediately',
      'Change your account PIN codes or passwords',
      'Request a replacement SIM card',
      'Ask them to note that your device was stolen',
    ],
    additionalInfo: !provider.phone ? `${provider.name} doesn't have a call centre - all support is provided online through your account or web chat.` : null,
  };
});

// Sort providers alphabetically
const sortedProviders = [...mobileProviders].sort((a, b) => a.name.localeCompare(b.name));

// Group by network for filter tabs
const networks = ['All', 'EE', 'O2', 'Three', 'Vodafone'];
---

<Layout 
  title="UK Mobile Provider Directory - Emergency Contacts | ProtectMyMobile"
  description="Complete directory of UK mobile network providers with emergency contact numbers to report stolen phones and block SIM cards."
>
  <Header />
  
  <main class="bg-[#f3f2f1]">
    <div class="container mx-auto px-4 py-6">
      <div class="mb-8">
        <h1 class="flex items-center text-3xl md:text-4xl font-bold mb-4">
          <Phone class="h-10 w-10 mr-3 flex-shrink-0 text-primary" />
          Mobile Provider Directory
        </h1>
        <p class="text-neutral-700 mb-6">
          Find your mobile provider from {sortedProviders.length} networks to report your stolen SIM and request a block on your number.
        </p>
        
        <!-- Search Box -->
        <div class="mb-6">
          <div class="relative">
            <Search class="absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 h-5 w-5" />
            <input
              id="provider-search"
              type="text"
              class="w-full pl-10 pr-3 py-2 border border-neutral-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Search for your mobile provider..."
            />
          </div>
        </div>
        
        <!-- Network Filter Tabs -->
        <div class="mb-6 flex flex-wrap gap-2">
          {networks.map((network, index) => (
            <button
              class={`network-filter px-4 py-2 rounded-lg transition-colors ${
                index === 0
                  ? 'bg-primary text-white'
                  : 'bg-neutral-200 text-neutral-700 hover:bg-neutral-300'
              }`}
              data-network={network.toLowerCase()}
            >
              {network}
            </button>
          ))}
        </div>
        
        <!-- Providers List -->
        <div class="space-y-4" id="provider-list">
          {sortedProviders.map(provider => (
            <div 
              class="provider-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
              data-network={provider.network.toLowerCase()}
            >
              <div class="flex items-start">
                <!-- Provider Initial Circle -->
                <div 
                  class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4 flex-shrink-0"
                  style={`background-color: ${provider.colour}`}
                >
                  {provider.initial}
                </div>
                
                <div class="flex-1">
                  <div class="flex items-start justify-between mb-3">
                    <div>
                      <h3 class="flex items-center text-xl font-semibold">{provider.name}</h3>
                      <p class="text-sm text-neutral-600">
                        Network: {provider.network} {provider.is_mvno && '(MVNO)'}
                      </p>
                    </div>
                    <a 
                      href={provider.website} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="text-sm text-primary hover:underline flex items-center"
                    >
                      <Globe class="h-4 w-4 mr-1" />
                      Website
                    </a>
                  </div>
                  
                  <!-- Emergency Contacts -->
                  <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                    <h4 class="flex items-center font-semibold text-red-900 mb-2 flex items-center">
                      <Phone class="h-4 w-4 mr-1" />
                      Emergency Contact
                    </h4>
                    <div class="space-y-1 text-sm">
                      <p><strong>UK:</strong> {provider.emergencyContact.uk.startsWith('Online') ? (
                        <span class="text-red-700">{provider.emergencyContact.uk}</span>
                      ) : (
                        <a href={`tel:${provider.emergencyContact.uk}`} class="text-red-700 hover:underline">{provider.emergencyContact.uk}</a>
                      )}</p>
                      <p class="text-neutral-600 italic">{provider.emergencyContact.available}</p>
                    </div>
                  </div>
                  
                  <!-- Steps to Take -->
                  <div class="mb-3">
                    <h4 class="font-semibold mb-2">Steps to Take:</h4>
                    <ol class="list-decimal pl-5 text-neutral-700 space-y-1 text-sm">
                      {provider.steps.map(step => (
                        <li>{step}</li>
                      ))}
                    </ol>
                  </div>
                  
                  <!-- Additional Info -->
                  {provider.additionalInfo && (
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-md text-sm">
                      <p class="text-blue-900"><strong>Note:</strong> {provider.additionalInfo}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
        
        <!-- Important Notes -->
        <div class="mt-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
          <h3 class="flex items-center font-semibold mb-3 flex items-center text-yellow-900">
            <AlertCircle class="h-5 w-5 mr-2" />
            Important Notes:
          </h3>
          <ul class="list-disc pl-5 space-y-2 text-neutral-700">
            <li>Report your SIM as stolen as soon as possible to prevent unauthorized use</li>
            <li>You'll need your phone number and account details when contacting your provider</li>
            <li>Ask for a reference number for your call/report</li>
            <li>Request that they note your device was stolen (not just lost)</li>
            <li>Order a replacement SIM to be sent to a safe address</li>
          </ul>
        </div>
      </div>
    </div>
  </main>
  
  <Footer />
  
  <script>
    // Search functionality
    const searchInput = document.getElementById('provider-search') as HTMLInputElement;
    const providerList = document.getElementById('provider-list');
    const networkButtons = document.querySelectorAll('.network-filter');
    let currentNetwork = 'all';
    
    if (searchInput && providerList) {
      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();
        filterProviders(query, currentNetwork);
      });
    }

    // Network filter
    networkButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const network = (e.target as HTMLButtonElement).dataset.network || 'all';
        currentNetwork = network;
        
        // Update button styles
        networkButtons.forEach(btn => {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-neutral-200', 'text-neutral-700');
        });
        (e.target as HTMLButtonElement).classList.remove('bg-neutral-200', 'text-neutral-700');
        (e.target as HTMLButtonElement).classList.add('bg-primary', 'text-white');
        
        // Filter providers
        const searchQuery = searchInput?.value.toLowerCase() || '';
        filterProviders(searchQuery, network);
      });
    });

    function filterProviders(searchQuery: string, network: string) {
      const providerCards = document.querySelectorAll('.provider-card');
      
      providerCards.forEach((card) => {
        const providerName = card.textContent?.toLowerCase() || '';
        const providerNetwork = (card as HTMLElement).dataset.network || '';
        
        const matchesSearch = providerName.includes(searchQuery);
        const matchesNetwork = network === 'all' || providerNetwork === network;
        
        if (matchesSearch && matchesNetwork) {
          (card as HTMLElement).style.display = '';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    }
  </script>
</Layout>
