---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getNewsPosts } from '@/lib/supabase';
import { Newspaper, Calendar, ExternalLink, ArrowRight } from 'lucide-react';

let posts = [];
let error = null;

try {
  posts = await getNewsPosts(true);
} catch (e) {
  error = e;
  console.error('Error fetching news posts:', e);
}

const categoryColors: Record<string, string> = {
  arrest: 'bg-red-100 text-red-800',
  seizure: 'bg-blue-100 text-blue-800',
  law_change: 'bg-purple-100 text-purple-800',
  statistics: 'bg-green-100 text-green-800',
  prevention_tip: 'bg-yellow-100 text-yellow-800',
  other: 'bg-gray-100 text-gray-800',
};

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}
---

<Layout 
  title="Latest News & Updates - UK Mobile Theft | ProtectMyMobile"
  description="Stay informed about the latest mobile theft news in the UK including arrests, seizures, law changes, and prevention tips."
>
  <Header />
  
  <main class="bg-[#f3f2f1]">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="flex items-center text-3xl font-bold mb-2">
          <Newspaper class="h-8 w-8 mr-3 text-primary" />
          Latest News & Updates
        </h1>
        <p class="text-lg text-neutral-700">
          Stay informed about mobile theft arrests, policy changes, and security updates across the UK.
        </p>
      </div>

      <!-- Category Filter (Future Enhancement) -->
      <div class="flex flex-wrap gap-2 mb-6">
        <span class="text-sm font-medium text-neutral-600">Filter by category:</span>
        <button class="px-3 py-1 rounded-full bg-primary text-white text-sm">All</button>
        <button class="px-3 py-1 rounded-full bg-neutral-200 text-neutral-700 text-sm hover:bg-neutral-300">Arrests</button>
        <button class="px-3 py-1 rounded-full bg-neutral-200 text-neutral-700 text-sm hover:bg-neutral-300">Seizures</button>
        <button class="px-3 py-1 rounded-full bg-neutral-200 text-neutral-700 text-sm hover:bg-neutral-300">Law Changes</button>
        <button class="px-3 py-1 rounded-full bg-neutral-200 text-neutral-700 text-sm hover:bg-neutral-300">Statistics</button>
      </div>

      {error ? (
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
          <p class="text-yellow-800">Unable to load news posts. Please try again later.</p>
        </div>
      ) : posts.length === 0 ? (
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
          <Newspaper class="h-16 w-16 mx-auto mb-4 text-neutral-400" />
          <h3 class="text-xl font-semibold mb-2">No News Posts Yet</h3>
          <p class="text-neutral-600 mb-4">Check back soon for the latest updates on mobile theft news in the UK.</p>
          <p class="text-sm text-neutral-500">In the meantime, explore our prevention guides and resources.</p>
        </div>
      ) : (
        <div class="space-y-6">
          {posts.map((post: any) => (
            <article class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
              <div class="p-6">
                  <div class="flex items-center gap-2 mb-3">
                    <span class={`text-xs px-2 py-1 rounded-full font-medium ${categoryColors[post.category] || categoryColors.other}`}>
                      {post.category.replace('_', ' ')}
                    </span>
                    <span class="text-sm text-neutral-500 flex items-center">
                      <Calendar class="h-4 w-4 mr-1" />
                      {formatDate(post.published_at || post.created_at)}
                    </span>
                  </div>
                  
                  <h2 class="text-2xl font-bold mb-3">
                    <a href={`/news/${post.slug}`} class="hover:text-primary transition-colors">
                      {post.title}
                    </a>
                  </h2>
                  
                  <p class="text-neutral-700 mb-4">
                    {post.excerpt}
                  </p>
                  
                  <div class="flex items-center justify-between">
                    <a href={`/news/${post.slug}`} class="text-primary font-medium hover:underline flex items-center">
                      Read more <ArrowRight class="h-4 w-4 ml-1" />
                    </a>
                    
                    {post.source_url && (
                      <a href={post.source_url} target="_blank" rel="noopener noreferrer" 
                         class="text-sm text-neutral-500 hover:text-neutral-700 flex items-center">
                        <ExternalLink class="h-3 w-3 mr-1" />
                        {post.source_name || 'Source'}
                      </a>
                    )}
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}
    </div>
  </main>
  
  <Footer />
</Layout>
